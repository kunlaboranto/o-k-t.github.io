<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="../../css/result.css">

        <title>[펌] Tablespace block map</title>
    </head>
    <body>
        <section id="wrap">
            <header>
                <h1 class="logo-title">
                    <span class="main"><img src="../../images/logo_egloos.png" width="105" height="34" alt="이글루스"></span>
                </h1>
                <div class="user-info">
                    <strong class="name">kun</strong> 님 (<strong class="name">okseop7</strong>)
                </div>
            </header>
            <main>
                <article class="post-wrap">
                    <!-- 게시물 정보 : 날짜 -->
                    <div class="post-info">
                        <span class="time">2008-02-06 18:11:13</span>
                    </div>
                    <!-- 게시물 제목 -->
                    <h2 class="post-title">[펌] Tablespace block map</h2>
                    <!-- 게시물 본문 -->
                    <div class="post-body">
                        <div class="content">From : http://toolkit.rdbms-insight.com/dbtools.php<br><br><br><div id="leftcontent"><h3><a href="http://www.rdbms-insight.com/">Home</a></h3><h3><a href="http://toolkit.rdbms-insight.com/index.php">Toolkit</a>:</h3><ul><li><a href="http://toolkit.rdbms-insight.com/index.php">Index</a></li><li><a href="http://toolkit.rdbms-insight.com/scripts.php">Scripts</a></li><li><a href="http://toolkit.rdbms-insight.com/quicktips.php">Quick Tips</a></li><li><a href="http://toolkit.rdbms-insight.com/publs.php">Articles / Publications</a></li><li><a href="http://toolkit.rdbms-insight.com/linkys.php">Links</a></li></ul> <h3>My <a href="http://www.orafaq.com/blog/5" target="_new">OraFAQ Blog</a></h3><h3><a href="http://www.rdbms-insight.com/contact.php">Contact me</a></h3></div><div id="rightcontent"><p>Get a nice ascii-art block map of a given datafile. (Accepts tablespacename as an argument and defaults to the first datafile in thetablespace.)</p><p>This can be a big help when trying to figure out what tablespaces need defragmenting, why a 300 M datafile only holds 100 M of data yet cannot be shrunk, etc.</p><p>The program divides the datafile into N chunks (you may specify N or the chunk size) and collects fragmentation and freespace data on each chunk.  The chunk data is stored in a table you must create, dbtools_blk_map.  The data is then printedout in a familiar tablespace-block-map format.  Columns and rows are numbered to allow for easy identification of particular chunks which you can then zoom in on by querying dbtools_blk_map directly, or by running the procedure zoom( chunk_id ); .</p><p>Requirements: </p><ul><li>Package owner must be explicitly granted select on sys.dba_extents and sys.dba_free_space</li><li>Package owner must own the dbtools_blk_map table specified in the code comments</li><li>Code assumes a consistent db_block_size of 4K.  If that's not the case in your database, change the db_block_size constant or, if using multiple block sizes, change the code to allow a block size to be passed in.</li></ul><p>Sample output:</p><pre class="wide">SQL&gt; set serverout on<br>SQL&gt; begin dbtools.ts_block_map(tablespace_name=&gt;'METADATA',num_chunks_in=&gt;400); end;<br>SQL&gt; /<br><br>Tablespace size: 1200 MB<br>Chunk size:  3072 KB<br>Blocks per chunk: 768<br>*** Tablespace map for METADATA ***<br>|      |0         1         2         3         4         5         6         7         8         9         |<br>|      |0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 |<br>+------+----------------------------------------------------------------------------------------------------+<br>|0     |####*##### #  ####     #### #-                                   # ## ##   #*=#*###**#*#*-### ##1###|<br>|100   |##*-########-  ==-   = . * *##=*#####*###*. ####             ###=##   # ##   #* =###-#####*#*###=##.|<br>|200   |   =-#####=#* ###=####**     ##.## ###############################-                  *##### ###=    |<br>|300   |                *  =               =                                *##*                            |<br><br>PL/SQL procedure successfully completed.<br><br>SQL&gt; exec dbtools.zoom(212);<br>Chunk label: 212<br>Blocks in chunk: 1280<br>Blocks: 271360 - 272639<br># blocks used: 717<br># pieces used: 2<br>Average used piece size: 358.5 blocks<br>Percent unused blocks: 44%<br>Summary of extents in this chunk:<br>OWNER                         SEGMENT_NAME                  NUM EXTENTS NUM BLOCKS AVG BLKS/EXTNT SMALLEST EXTNT<br>-------------------------------------------------------------------------------------------------------<br>HR_DATA                       EXTRA_COMP                    1           65         65             65<br>HR_DATA                       PS_DIRECTORY_V                1           652        652            652<br><br>PL/SQL procedure successfully completed.<br><br><br></pre><p>Package code:</p><pre class="wide">create or replace<br>package dbtools <br>is<br><br>  procedure ts_block_map (tablespace_name in varchar2, <br>     file_id in number default null,<br>     num_chunks_in number default null, <br>     chunk_bytes_in in number default null);<br>  procedure print_map (chunk_list in varchar2, num_chunks number);<br>  procedure print_map_from_table ;   <br>  procedure zoom ( chunk_label in number ) ;<br>end ;<br>/<br>create or replace<br>package body dbtools is <br>                      <br>/*                   <br>create table dbtools_blk_map<br>(file_id number,           <br>block_id number,          <br>chunk_size_in_blocks number,<br>sum_used_blocks number,    <br>used_pieces number,       <br>avg_used_piece_size number,<br>sum_unused_blocks number, <br>percent_unused number,<br>chunk_label number,<br>chunk_symbol char(1)<br>);                   <br>*/                  <br>                  <br>procedure ts_block_map (tablespace_name in varchar2, <br>  file_id in number default null,<br>  num_chunks_in number default null, <br>  chunk_bytes_in in number default null)<br>is  <br><br>num_chunks number; <br>chunk_size number; --in blocks <br>chunk_bytes number; --in bytes<br>ts_bytes number;             <br>file# number;               <br>db_block_size number;      <br>                          <br>this_chunk_symbol char(1);<br>chunk_list varchar2(32767);<br>                          <br>this_chunk_start_block number;<br>this_chunk_end_block number; <br>                            <br>this_chunk_usedblks number;<br>this_chunk_pieces number; <br>this_chunk_chunksize number;<br>this_chunk_freeblks number;<br>this_chunk_pctfree number;<br>                         <br>piece_threshold_1 number;<br>piece_threshold_2 number;<br>                        <br>this_chunkID number;   <br>                      <br>begin                <br>                    <br>dbms_output.enable(2000000);<br>delete from dbtools_blk_map;<br>commit;                    <br>                          <br>db_block_size := 4096;   <br>piece_threshold_1 := 21;<br>piece_threshold_2 := 31;<br>                       <br>if num_chunks_in is not null then<br>num_chunks := num_chunks_in;<br>else                               <br>num_chunks := 200;        <br>end if;                          <br>                                <br>if ts_block_map.file_id is null then<br> select min(file_id) into file#    <br> from sys.dba_data_files df       <br> where df.tablespace_name=upper(ts_block_map.tablespace_name);<br>else                                                         <br> file# := ts_block_map.file_id;                             <br>end if;                                      <br>                                            <br>select df.bytes                            <br>into ts_bytes                             <br>from sys.dba_data_files df where df.file_id=file#;<br>                                                <br>if ( chunk_bytes_in is not null and num_chunks_in is null) then<br>num_chunks := ceil(ts_bytes/chunk_bytes_in);          <br>end if;                                                      <br>                                                           <br>chunk_size := ceil(ts_bytes/(num_chunks*db_block_size)); --round up<br>chunk_bytes := chunk_size * db_block_size ;        <br>                                                 <br>dbms_output.put_line ( 'Tablespace size: ' || ts_bytes/(1024*1024) || ' MB' );<br>dbms_output.put_line ( 'Chunk size:  ' || chunk_bytes/(1024) || ' KB');<br>dbms_output.put_line ( 'Blocks per chunk: ' || chunk_size ); <br><br>this_chunk_start_block := 0;<br>this_chunkid := 0;         <br>while this_chunk_start_block &lt; ts_bytes/db_block_size<br>loop<br>  begin &lt;<selblock>&gt;<br>    select sum(blk_in_chunk), count(blk_in_chunk), avg(blk_in_chunk),<br>    chunk_size-sum(blk_in_chunk),                                   <br>    ((chunk_size-sum(blk_in_chunk))/chunk_size)*100               <br>    into this_chunk_usedblks, this_chunk_pieces, this_chunk_chunksize,<br>    this_chunk_freeblks, this_chunk_pctfree                         <br>    from                                                           <br>    (                                                             <br>    select segment_name, block_id, blocks, bytes,                <br>    case                                                        <br>     when block_id &lt; this_chunk_start_block then<br>(blocks+block_id-this_chunk_start_block)       <br>     when (block_id+blocks) &gt; this_chunk_start_block+chunk_size-1<br>     then (this_chunk_start_block+chunk_size-1-block_id)     <br>     else blocks                                               <br>    end blk_in_chunk --blocks of this extent in the chunk     <br>    from sys.dba_extents e where e.file_id=file#             <br>    and (block_id between this_chunk_start_block and<br>(this_chunk_start_block+chunk_size-1)              <br>        or                                        <br>        (block_id+blocks-1) between this_chunk_start_block and<br>(this_chunk_start_block+chunk_size-1) )                      <br>    );                                                      <br>exception                                          <br>  when no_data_found then                          <br>    this_chunk_pctfree := 100;                      <br>      this_chunk_usedblks:=0;                          <br>      this_chunk_pieces:=0;                           <br>      this_chunk_chunksize:=0;                       <br>      this_chunk_freeblks:=chunk_size;              <br>    when others then                               <br>    raise;                                    <br>end selblock;                            <br>                                                <br>  if ( this_chunk_pctfree=100 or this_chunk_pctfree is null) then<br>  this_chunk_symbol := ' ' ;                             <br>  elsif this_chunk_pctfree &gt;= 90 then                         <br>  this_chunk_symbol := '.' ;                           <br>  elsif ( this_chunk_pctfree between 70 and 90 and this_chunk_pieces &lt;<br>piece_threshold_1) then                                             <br>  this_chunk_symbol := '-' ;                                 <br>  elsif ( this_chunk_pctfree between 50 and 70 and this_chunk_pieces &lt;<br>piece_threshold_1) then                                              <br>  this_chunk_symbol := '=' ;                                  <br>  elsif ( this_chunk_pctfree between 30 and 50 and this_chunk_pieces &lt;<br>piece_threshold_1) then                                              <br>  this_chunk_symbol := '*';<br>  elsif ( this_chunk_pctfree between 10 and 30 and this_chunk_pieces &lt;<br>piece_threshold_1) then<br>    this_chunk_symbol := '@';           <br>  elsif ( this_chunk_pctfree between 0 and 10 and this_chunk_pieces &lt;<br>piece_threshold_1) then<br>    this_chunk_symbol := '#';  <br>  elsif ( this_chunk_pieces &gt; piece_threshold_1 ) then<br>  this_chunk_symbol := '1';                    <br>  elsif (this_chunk_pieces &gt; piece_threshold_2) then <br>  this_chunk_symbol := '2';                   <br>  else                                             <br>  this_chunk_symbol := '!'; --should not reach this case<br>  end if;                                                   <br>                                                          <br>insert into system.dbtools_blk_map (file_id, block_id,<br>chunk_size_in_blocks,                                        <br>  sum_used_blocks, used_pieces, avg_used_piece_size,        <br>  sum_unused_blocks, percent_unused, chunk_label, chunk_symbol)<br>  values (file#, this_chunk_start_block, chunk_size,          <br>  this_chunk_usedblks, this_chunk_pieces, this_chunk_chunksize,<br>  this_chunk_freeblks, this_chunk_pctfree, this_chunkID, this_chunk_symbol) <br>  ;                                                                        <br>commit;                                                           <br>                                                                       <br>                                                                      <br>  chunk_list := chunk_list || this_chunk_symbol ;                <br>                                                                  <br>  this_chunk_start_block := this_chunk_start_block + chunk_size ;  <br>  this_chunkID := this_chunkID + 1;                           <br>                                                             <br>end loop;                                                   <br>                                                           <br>dbms_output.put_line ( ' ');                              <br>dbms_output.put_line ( '*** Tablespace map for ' ||<br>upper(ts_block_map.tablespace_name) || ' ***');   <br>print_map ( chunk_list, num_chunks );            <br>                                                <br>end ts_block_map;                              <br>                                              <br>procedure print_map (chunk_list in varchar2, num_chunks number)<br>is                                                            <br>                                                             <br>--print nicely in rows of 100 symbols per row               <br>--set pagesize to at least 110                             <br>                                                          <br>to_print varchar2(32767);                                <br>i number;                                               <br>j number;                                              <br>                                                      <br>begin                                                <br>                                                   <br>dbms_output.put_line ( '|      |0         1         2         3         4         <br>5         6         7         8         9         |');              <br>dbms_output.put_line ( '|      |0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 0 2 4 6 <br>8 0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 |');              <br>dbms_output.put_line ( <br>'+------+----------------------------------------------------------------------------------------------------+');<br><br>j := ceil(num_chunks/100)-1 ;<br>i := 0;                     <br>to_print := chunk_list || '[END]' ;<br>for i in 0..j                     <br>loop                             <br>dbms_output.put_line ('|' || rpad(i*100,6) || '|' ||<br>rpad(substr(to_print,1,100),100) || '|');                  <br>  to_print := substr(to_print,101,length(to_print));      <br>                                                         <br>end loop;                                               <br>                                                       <br>end print_map;                                        <br>                                                     <br>procedure print_map_from_table                      <br>is                                                 <br>                                                  <br>chunk_list varchar2(32767);                      <br>cursor mycur is                                 <br>select db.chunk_symbol                         <br>from system.dbtools_blk_map db               <br>order by chunk_label ;                      <br>num_chunks number;                         <br>                                          <br>begin                                    <br>for d in mycur loop             <br>  chunk_list := chunk_list || d.chunk_symbol;<br>  end loop;                                       <br>  select count(*) into num_chunks                <br>  from system.dbtools_blk_map db                <br>;                                      <br>print_map(chunk_list, num_chunks);    <br>end;                                         <br><br><br>procedure zoom ( chunk_label in number ) is<br>--Zoom in on a chunk in dbtools_blk_map<br><br>trow dbtools_blk_map%rowtype ;<br><br>firstblk number;<br>lastblk number;<br><br>cursor zoomcur (first_block number, last_block number, file number) <br>is<br>    select owner, segment_name, count(*) num_extents, sum(blk_in_chunk) <br>num_blocks, avg(blk_in_chunk) avg_extent_blocks,<br>    min(blk_in_chunk) min_extent_blocks<br>    from<br>    (select owner,<br>    segment_name,<br>    case<br>         when block_id &lt; zoomcur.first_block then<br>            (blocks+block_id-zoomcur.first_block)<br>         when (block_id+blocks) &gt; zoomcur.last_block then <br>(zoomcur.last_block-block_id)<br>         else blocks<br>    end blk_in_chunk<br>    from<br>     dba_extents<br>     where ( block_id between zoomcur.first_block and zoomcur.last_block <br>            OR <br>             (block_id+blocks-1) between zoomcur.first_block and <br>zoomcur.last_block<br>           ) <br>     and file_id=zoomcur.file<br>    )<br>     group by owner, segment_name<br>;<br><br>begin<br><br>dbms_output.put_line ('Chunk label: ' || chunk_label);<br><br>select * into trow from dbtools_blk_map db where db.chunk_label = <br>zoom.chunk_label;<br>dbms_output.put_line (' ');<br>dbms_output.put_line ('Blocks in chunk: ' || trow.chunk_size_in_blocks );<br>firstblk := trow.block_id;<br>lastblk := trow.block_id + trow.chunk_size_in_blocks - 1 ;<br>dbms_output.put_line ('Blocks: ' || firstblk || ' - ' || lastblk );<br>dbms_output.put_line ('# blocks used: ' || trow.sum_used_blocks );<br>dbms_output.put_line ('# pieces used: ' || trow.used_pieces );<br>dbms_output.put_line ('Average used piece size: ' || <br>round(trow.avg_used_piece_size,1) || ' blocks');<br>dbms_output.put_line ('Percent unused blocks: ' || round(trow.percent_unused,1) <br>|| '%' );<br>dbms_output.put_line (' ');<br>dbms_output.put_line ('Summary of extents in this chunk:');<br>dbms_output.put_line (rpad('OWNER',30) || rpad('SEGMENT_NAME',30) || rpad ('NUM <br>EXTENTS',12)<br>|| rpad('NUM BLOCKS',11) || rpad('AVG BLKS/EXTNT',15) || rpad('SMALLEST <br>EXTNT',15) ) ;<br>dbms_output.put_line <br>('-------------------------------------------------------------------------------------------------------');<br>for z in zoomcur (firstblk, lastblk, trow.file_id) <br>loop<br>  dbms_output.put_line (rpad(z.owner,30) || rpad(z.segment_name,30) || <br>rpad(z.num_extents,12)<br>  || rpad (z.num_blocks,11) || rpad(round(z.avg_extent_blocks),15) <br>  || rpad (z.min_extent_blocks,15));<br>end loop;<br>dbms_output.put_line (' ');<br><br>end zoom;<br><br>                                                                                                                                                      <br>end dbtools;                                                                                                                                          <br><br></selblock></pre><hr><font size="-1"><i><b>Note:</b> Proofread any scripts before using. Always try scripts on a test instance first. I'm not responsible for any damage, even if you somehow manage to make my scripts corrupt every last byte of your data, set your server on fire and serve you personally with an eviction notice from your landlord! <br>All scripts and tips © Natalka Roshak 2001-2005. <br><b>Enjoy the FREE tips folks...</b></i></font></div><br></div>
                        <div class="post-footer">
                            <button class="btn" onclick="button_click();">목록</button>
                        </div>
                    </div>
                </article>
            </main>
        </section>

        <script src="https://code.jquery.com/jquery-3.5.1.js"></script>

        <script>
            function button_click() {
                if(history.length > 1) {
                    history.back();
                } else {
                    document.location.href = "../../블로그포스트목록.html";
                }
            }
        </script>
    </body>
</html>
